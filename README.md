---
marp: true
---

# EKS with Consul and Demo App

## Step 1: Setup an AWS Account

- Create an IAM User so that you aren't using your root user.
- Grant this user access to the `AdministratorAccess` managed policy.
- Configure your AWS CLI to use this account as the default profile for the time being.

See the Official Documentation for instructions on how to complete these steps.

### Official Documentation

1. [Create an AWS account](https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/)
2. [Create an Administrator IAM User](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html)
3. [Create Access Key for Administrator User](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html)
4. [Install AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
5. [Configure the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html)

## Step 2: Create an IAM Role to use later in your Kube Configuration

- Open a terminal and navigate to the `python-for-aws-iam` directory
- Make sure `main.py` is executable: `chmod +x ./main.py`
- Execute the `main.py` script:
  - `./main.py -r <name-to-use-for-role> -u <name-to-use-for-user> -e <aws-environment-name> --aws-config-file <path/to/your/aws/config-file> --aws-credentials-file <path/to/your/aws/credentials-file>`
- Make note of the outputs

## Step 3: Create a KMS Key to Use with SOPS Tool

- Add the role arn from step 2 as the value for `role_arn` in `kms-sops/terragrunt/dev/dev-vars.yaml`.
- Add the user name from step 2 as the value for `aws_profile` in `kms-sops/terragrunt/dev/dev-vars.yaml`
- Open a terminal and navigate to the `kms-sops/terragrunt/dev/` directory.
- Execute: `export AWS_PROFILE=<name-of-the-user-created-in-step-2>`
- Execute `terragrunt init`
- Execute `terragrunt run-all plan` and review output
- Execute `terragrunt run-all apply --terragrunt-non-interactive`.
- Make note of the outputs
- Create a repository env variable in your Github repo named SOPS_KEY and set the value to the arn of the key created above.

## Step 4: Create Github OIDC AWS Resources

- Add the role arn from step 2 as the value for `role_arn` in `github-oidc/terragrunt/dev/dev-vars.yaml`.
- Add the user name from step 2 as the value for `aws_profile` in `github-oidc/terragrunt/dev/dev-vars.yaml`
- Open a terminal and navigate to the `github-oidc/terragrunt/dev/` directory.
- Execute `terragrunt init`
- Execute `terragrunt run-all plan` and review output
- Execute `terragrunt run-all apply --terragrunt-non-interactive`.
- Make note of the outputs
- Login to your Github Account and navigate to this repo.
- Click on the Settings tab
- Click on the Security -> Secrets and Variables Drop Down Menu in the sidebar.
- Click Actions
- Click the New repository secret button
- Set the name value to `READ_ROLE`
- Set the value of the variable to the arn of the role created for Github OIDC above.

## Step 5: Encrypt role arn file and add to EKS IaC

- Open a terminal and navigate to the `eks/terragrunt/dev/` directory.
- Create a file name `unencrypted.yaml`
- Set its content to
  - `aws_role_arn: <arn-of-the-role-created-in-step-2>`
  - `aws_user_arn: <arn-of-the-user-created-in-step-2>`
  - `aws_user_name: <name-of-the-user-created-in-step-2>`
- Run the following:
  - `export AWS_PROFILE=<name-of-the-user-created-in-step-2>`
  - `aws sts assume-role --role-arn <arn-of-the-role-created-in-step-2> --role-session-name session | cat`
  - `export AWS_ACCESS_KEY_ID=<value-of-AccessKeyId-from-assume-role-command>`
  - `export AWS_SECRET_ACCESS_KEY=<value-of-SecretAccessKey-from-assume-role-command>`
  - `export AWS_SESSION_TOKEN=<value-of-SessionToken-from-assume-role-command>`
- Run the command `sops --encrypt -k <arn-of-kms-key-created-in-step-3> unencrypted.yaml > arn.enc.yaml`.
- Delete the `unencrypted.yaml` file
- Commit the new file
- Push your changes

## Step 6 (Optional): Download and Use Kubeconfig

- Download the kubeconfig artifact generated by the Github Actions workflow generated in Step 6
- Unzip the archive
- Run `sops -d kubeconfig.env.yaml > config`
- Move the `config` file to your `.kube` folder
- Run the following:
  - `export AWS_PROFILE=<name-of-the-user-created-in-step-2>`
  - `aws sts assume-role --role-arn <arn-of-the-role-created-in-step-2> --role-session-name session | cat`
  - `export AWS_ACCESS_KEY_ID=<value-of-AccessKeyId-from-assume-role-command>`
  - `export AWS_SECRET_ACCESS_KEY=<value-of-SecretAccessKey-from-assume-role-command>`
  - `export AWS_SESSION_TOKEN=<value-of-SessionToken-from-assume-role-command>`
- Make sure to unset these when you are done, and before proceeding with subsequent steps
